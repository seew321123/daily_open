- [ ] 简单熟悉充电桩通信流程

  - ```
    my_keda_*.py: 科大桩通信相关，现因科大桩不投入使用已经没用了；
    my_yfy_*.py: 英飞源桩通信相关，目前投入使用的版本为快卜修改过的 3.0 版本；
    my_conn_handler.py: 处理 tcp 连接的基类，功能包括维护与桩的连接上下文、 asyncio 的任务分发和销毁、redis pubsub。由 my_keda_handler.py 与 my_yfy_handler.py 继承；
    my_publisher.py: 供外部调用处理与桩的连接上下文之间的消息收发；
    my_task.py: 在桩推送的状态记录上建立 es 索引的计划任务；
    
    
    英飞源部分
    my_yfy_dataclass.py: 定义英飞源通信协议的命令枚举类和报文内容类；
    my_yfy_handler.py: 维护与桩的连接上下文；
    my_yfy_pile_frame.py: 英飞源通信协议的工具函数；
    my_yfy_testpile.py: 模拟英飞源桩与平台通信的类；
    ```

  - 科大与英飞源的充电桩处理类都继承于my_conn_handler.py中的基类BasicHandler。在index文件中的on_tcp_connect里，实例化yfy_handler后，通过重载的wait_msg函数中的while true 将循环阻塞。

  - 获取到报文后，首先验证报文的头部8个16进制数是否符合要求，通过头部信息判断报文剩余长度，再次read，最后将两部分内容进行校验，合并。判断报文类型以及其他参数，进入在while true中预设的报文类型的处理流程。

  - 有关命令超时的处理方式，控制器云函数的命令通过调用publish2云函数，初始化一个publisher.他将接收的命令类型，参数等用于执行下一步操作。同时操作和timeout任务放置到task中一起跑，任何一个率先完成后都会结束另一个，抛出结果。

- [ ] 充电桩常见问题排查流程

  - 手算报文的基础入门，

    ![image-20210304184001235](C:\Users\47174\AppData\Roaming\Typora\typora-user-images\image-20210304184001235.png)

    ```
    假设收到一个桩推送的推送报文字符串，扣除前八位头部后，理论上由上图可知底5至36字节代表桩编号。考虑到报文字符串内容大概率可读性很差无法赋值，因此假设我们收到报文后，已经将其整体list -> 子元素ord后在进行hex操作转为一个长度为32的16进制数的数组。
    hex_list = ['0x32', '0x39', '0x30', '0x30', '0x33', '0x30', '0x30', '0x38', '0x30', '0x30', '0x31', '0x30', '0x33', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0']
    通过int(item, 16)将其转为十进制数，通过chr转为对应ascii码对应的字符，可以看到数组转为
    res = ['2', '9', '0', '0', '3', '0', '0', '8', '0', '0', '1', '0', '3', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00']
    过滤其中用于补零的\x00字符，就是对应的桩编码了
    ```

  - 查看桩日志表，通过筛选 数据的type，start ,record这样的关键词对应开始充电命令以及结束充电返回充电记录的报文上下文打印结果，这里的参数都已经转译可以看的很清楚。

- [ ] 接入一个新的充电桩流程

  - 首先在平台管理页面创建一个桩条目。最少只需要填写一个ip地址即可。通常没有人能够告诉我们一个桩的IP地址是多少。这就需要我们首先将桩上的服务端ip地址端口号配置成

    ```
    ip：101.132.25.179，port：9303
    ```

    然后通过急停重启按钮，对桩进行重启。最后查看桩通讯日志中是否增加了很多type为noise的数据，查看其中对应的ip地址，大概率就是桩对应的ip地址。在管理后台添加以后，桩体其他的必填信息将会自动补充，包括桩下对应的枪数据也会自动创建。

- [ ] 充电桩功能测试流程

  - 具体查看测试桩与index中对应的测试数据上下文联系一下。

- [ ] 后台权限配置流程

  - 首页侧边栏添加(admin.get_homepage_sidebar)
  - 管理员角色权限树添加(admin_role.get_default_permission) ps:权限树中的非页节点全部设置为false，否则el组件会出现异常。
  - 管理员权限的更新(权限树结构更新时对已有管理员角色进行权限更新，默认将新的权限设置为false)
  - 在页面中，权限可能分为功能模块权限以及数据库字段权限，根据当前用户账号以及页面返回到前端为accessPermission 以及 datasetPermission.通过两个计算属性，对树进行递归校验相应的权限id对应的toggle是否为true.